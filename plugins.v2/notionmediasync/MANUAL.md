# Notion 媒体同步插件 - 使用手册

本手册详细介绍如何配置和使用 Notion 媒体同步插件。

## 目录

- [前置准备](#前置准备)
- [Notion 配置](#notion-配置)
- [插件配置](#插件配置)
- [数据库模板](#数据库模板)
- [功能说明](#功能说明)
- [常见问题](#常见问题)

---

## 前置准备

### 1. Notion 账号

确保你有一个 Notion 账号。免费版即可使用，但有一定的 API 调用限制。

### 2. MoviePilot 环境

- MoviePilot v2.x 或更高版本
- 已配置好媒体整理功能

---

## Notion 配置

### 步骤 1: 创建 Integration

1. 访问 [Notion Integrations](https://www.notion.so/my-integrations)
2. 点击 **「+ New integration」**
3. 填写基本信息：
   - **Name**: `MoviePilot Media Sync`（或任意名称）
   - **Associated workspace**: 选择你的工作区
4. 点击 **「Submit」** 创建
5. 复制 **Internal Integration Token**（以 `secret_` 开头）

> ⚠️ **重要**: Token 只显示一次，请妥善保存！

### 步骤 2: 创建数据库

1. 在 Notion 中创建一个新页面
2. 输入 `/database` 选择 **「Database - Full page」**
3. 为数据库命名，如「媒体库」

### 步骤 3: 连接 Integration

1. 打开刚创建的数据库页面
2. 点击右上角 **「...」** 菜单
3. 选择 **「+ Add connections」**
4. 搜索并选择你创建的 Integration
5. 点击 **「Confirm」**

### 步骤 4: 获取数据库 ID

数据库 ID 可以从 URL 中获取：

```
https://www.notion.so/workspace/数据库ID?v=xxx
                          ^^^^^^^^^^^^^^^^
                          这部分就是数据库 ID (32位)
```

或者从分享链接中获取：
```
https://www.notion.so/数据库ID?v=xxx
```

---

## 插件配置

### 配置项说明

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 启用插件 | 是否启用自动同步 | 关闭 |
| 发送通知 | 同步完成后是否发送通知 | 开启 |
| 跳过已存在 | 是否跳过数据库中已有的条目 | 开启 |
| Notion Token | Integration Token | - |
| 数据库 ID | Notion 数据库 ID | - |
| 媒体类型过滤 | 只同步指定类型的媒体 | 全部 |

### 配置步骤

1. 进入 MoviePilot 后台
2. 导航到 **设置 → 插件**
3. 找到 **「Notion媒体同步」** 插件
4. 填写配置：
   - 粘贴 Notion Integration Token
   - 粘贴数据库 ID
   - 根据需要调整其他选项
5. 开启 **「启用插件」**
6. 点击 **「保存」**

---

## 数据库模板

### 推荐的数据库结构

你可以手动创建以下属性，或让插件自动创建技术信息相关属性：

#### 基础属性（建议手动创建）

| 属性名 | 类型 | 创建方式 |
|--------|------|----------|
| 标题 | Title | 数据库自带 |
| 原始标题 | Text | 手动创建 |
| 类型 | Select | 手动创建 |
| 年份 | Number | 手动创建 |
| 评分 | Number | 手动创建 |
| 封面 | Files & media | 手动创建 |
| 简介 | Text | 手动创建 |
| 数据源 | Select | 手动创建 |

#### 技术信息属性（自动创建）

以下属性会在插件初始化时自动创建（如果不存在）：

| 属性名 | 类型 |
|--------|------|
| 分辨率 | Select |
| 视频编码 | Text |
| 音频格式 | Text |
| 来源 | Select |
| 发布组 | Text |
| 季数 | Number |
| 集数 | Text |

### 类型选项配置

建议为「类型」属性预设以下选项：

- 电影
- 剧集
- 动画电影
- 动画剧集

### 数据源选项配置

建议为「数据源」属性预设以下选项：

- TMDB
- Bangumi

---

## 功能说明

### 自动同步流程

```
媒体整理完成
    ↓
TransferComplete 事件触发
    ↓
检查媒体类型过滤
    ↓
构建媒体数据（包含技术信息）
    ↓
判断动画类型
    ↓
检查重复（如果启用）
    ↓
创建/更新 Notion 页面
    ↓
保存同步历史
    ↓
发送通知（如果启用）
```

### 技术信息提取

插件会从媒体文件名中提取以下技术信息：

| 信息 | 示例 |
|------|------|
| 分辨率 | 1080p, 2160p, 4K, 720p |
| 视频编码 | H265, x264, HEVC, AV1 |
| 音频格式 | AAC, DTS, TrueHD, Atmos |
| 来源 | WEB-DL, BluRay, HDTV, DVDRip |
| 发布组 | CMCT, CHD, HDChina 等 |

### 动画识别

插件通过 TMDB 的 `genre_ids` 判断是否为动画：

- **genre_id = 16** 表示 Animation（动画）类型
- 如果是动画 + 电影 → 「动画电影」
- 如果是动画 + 电视剧 → 「动画剧集」

### 重复检测

当启用「跳过已存在」时，插件会：

1. 根据标题在数据库中搜索
2. 如果找到匹配项，跳过同步
3. 在历史记录中标记为「跳过」

---

## 常见问题

### Q: 为什么某些属性没有同步？

**A**: 可能的原因：

1. 数据库中没有对应的属性 - 插件会自动跳过不存在的属性
2. 媒体文件名中没有相关信息 - 技术信息依赖文件名解析
3. Integration 权限不足 - 确保已正确连接到数据库

### Q: 如何手动触发同步？

**A**: 目前插件只支持自动同步（媒体整理完成后触发）。手动同步功能计划在后续版本中添加。

### Q: 属性自动创建失败怎么办？

**A**: 属性创建失败不会影响同步功能，只是新字段不会被填充。可能的原因：

1. Integration 没有数据库编辑权限
2. Notion API 限制

解决方法：手动在 Notion 中创建缺失的属性。

### Q: 为什么动画没有被正确识别？

**A**: 动画识别依赖 TMDB 的类型标签。如果 TMDB 上该媒体没有标记为 Animation (genre_id=16)，则不会被识别为动画。

### Q: 如何查看同步历史？

**A**: 在插件详情页面可以查看最近 100 条同步记录，包括：

- 同步状态（成功/跳过/失败）
- 同步时间
- 媒体信息

### Q: Token 泄露了怎么办？

**A**: 立即执行以下操作：

1. 访问 [Notion Integrations](https://www.notion.so/my-integrations)
2. 找到对应的 Integration
3. 点击 **「Regenerate secret」** 重新生成 Token
4. 更新 MoviePilot 中的配置

---

## 技术支持

如遇到问题，请：

1. 查看 MoviePilot 日志中的错误信息
2. 确认 Notion Integration 配置正确
3. 检查数据库权限设置

## 更新记录

- **v2.0.0**: 新增技术信息同步、动画分类、属性自动创建
- **v1.0.0**: 初始版本
